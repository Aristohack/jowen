+++
draft = true
date = 2021-05-21T19:10:10+08:00
title = "Git管理规范"
description = "对包括基本使用、环境部署、二次开发以及大厂实践经验进行简单介绍。"
slug = ""
tags = []
categories = ["Git"]
externalLink = ""
series = []
+++
<a name="BKM5a"></a>
# 文档说明
此文档用于说明，**应用开发**上怎样使用Git进行功能分支方式代码开发，**应用代码**的版本怎样命名等。这是一份适用于代码开发同学的文档。
<a name="riRCM"></a>
## 适用范围
**内研产品，部分项目产品**
<a name="dLktR"></a>
## 适用人员
开发人员

---

<a name="2qavw"></a>
# 应用版本
这里应用版本中的应用不是指产品，而是指各独立模块的应用（application），最简单的说明就是一个git仓库就是一个应用。
<a name="hJfXM"></a>
## 版本命名
版本采用GNU风格Major_Version_Number.Minor_Version_Number.Revision_Number[.Build_Number]，如4.8.2

- major，主版本号；主版本不同程序集不能替换，不往下兼容。如，功能重写、框架重构情况下改变此版本
- minor，次版本号；主版本号相同，而次版本号不同，是指**显著的内容**增强，但需要往下兼容。比如，保持兼容性情况下新功能发布
- revision，修订号；主次版本号相同，而修订号不同，正常是指bug的修复或者非功能性内容修正，这边版本是可以互换的
- build，编译版本号；只是对内的版本号，使用同样的代码但环境不同编译时或多次编译时，加的版本号
  <a name="sRCnl"></a>
## 管理策略
应用版本的管理策略，如下：

- 当应用进行局部修改或者bug修正时，主次版本号不变，修订号+1
- 当应用在原有的基础上添加了新的功能，或者改善了性能及稳定性，主版本号不变，次版本号+1，修订号归0
- 当应用在进行了重大修改，或者局部功能大量修改而导致项目应用发生全局变化时，主版本号+1，次版本号、修订号归0

---

<a name="7fjgV"></a>
# 流程说明
代码开发上，我们采用功能分支的开发模式。这里，分支类型包含下面**5类**：

- Master主分支，此分支只能有1个，是应用稳定版本的分支；改分支需要被保护
- Develop开发分支，此分支只能有1个，是代表当前迭代版本的分支；改分支需要被保护
- Feature功能分支，这类分支可以有多个，一个分支代表一个完整功能，正常情况下会有多个功能分支并存；此类分支只能从开发分支分出来，也只能合回到开发分支上。一个功能分支开发完后，该分支需要删除
- Release发布分支，这类分支可以有多个；通常情况下，同一时间只会有一个；此类分支只能从功能分支创建，但可按实际情况，可合回到开发分支继续开发，或合到主分支进行发版；此类分支需要被保护
- hotfix热修复分支，这类分支可以有多个

![adgdsgfhtjtj.png](../../../images/adgdsgfhtjtj.png)

<a name="IQD1j"></a>
## 开发流程
当一个新版本迭代开始时，主要的研发流程如下：

1. 从主分支上同步代码到开发分支。如果此次迭代是源于上次迭，就无需从主分支上拉代码了
1. 每一个完整的功能任务（对应禅道项目上的一个任务），建一个功能分支；当次分支开发结束时，提交代码合并申请，由Leader进行代码的合并，合并代码后，删除此功能分支
1. 当前迭代所有功能分支都合并到开发分支上，并且到达提测要求时，就可以从开发分支上拉一个发布分支，进入提测流程或者自测SIT
1. 提测后，轻易bug的修改直接合并到发布分支；如果提测问题较大，需要把发布分支退回到开发分支；
1. 当提测完毕后，发布分支要合并回开发分支；如果提测通过发版，那么需要把发布分支合并到主分支上；
   <a name="A5N9j"></a>
### 注意事项

- 不在当前迭代上的功能分支，不能合并到开发分支上
- 功能分支合并到开发分支上，需要创建Merge请求，并由Leader进行代码合并。在merge代码时需要带上--no-off参数，已保留被合并的分支信息
  <a name="9VV4r"></a>
### 其他事项

- 一位同学负责一个功能分支，可以直接向这个分支提交代码。多人负责一个功能分支开发，可以每位同学创建一个该功能开发的分支，最终合并到此功能分支上

<a name="ORFJr"></a>
## 提测流程
当从开发分支上创建一个发布分支，后续测试修bug流程如下：

1. 在发布流程上打一个发布tag，使用该tag来发布测试环境或者SIT环境；
1. 在下一个测试环境发布窗口期前，把修bug分支合并到发布分支，并新打一个发布发布tag；
1. 在下一个测试环境发布窗口期到来时，把上面步骤打的tag发布测试环境或者SIT环境，进行下轮测试；
1. 上面过程不断迭代，知道提测失败或者提测成功；
  1. 提测失败，把分支代码合回到开发分支，并删除发布分支及这次发布所打的tag
  1. 提测成功，把发布的tag代码合并到主干分支，并打出应用版本tag；同时，把分支代码合回到开发分支，并删除发布分支及这次发布所打的tag
     <a name="q8BrS"></a>
### 注意事项

- 修bug分支的代码合并到发布分支上，需要创建Merge请求，并由Leader进行代码合并
- 发布分支的tag合并到开发分支上及主干分支上，需要创建Merge请求，并由Leader进行代码合并。在merge代码时需要带上--no-off参数，以保留被合并的分支信息

<a name="botLr"></a>
## hotfix流程
当发生hotfix的情况下，采用下面流程来进行代码操作：

1. 从发生问题的应用版本tag上拉取一个hotfix分支，在此分支上修复问题；
1. 当确定问题修复后，直接从hotfix分支上打出修复问题后新应用版本的tag；
1. 当确定问题修复后，需要根据实际情况，把修复的代码合并到其他分支上：
  1. 如果当前迭代的开发分支也有此问题，并且和拉hotfix分支的tag兼容，那么把hotfix分支直接合并回开发分支上
  1. 判断当前发生问题的应用版本的大版本的最后一个版本（如发生问题的是4.8.2版本，现4.x的版本是4.10.3版本，那边就要检查4.10.3版本是否有这个问题），如果有和hotfix兼容，那么把hotfix分支直接合并到此分支上。（这步根据实际情况，来看是否需要操作）
4. 改合并的分支合并完后，过了观察期（30天），删除此hotfix分支
   <a name="F3roy"></a>
### 注意事项

- 把hotfix分支合并到其他分支上，需要创建Merge请求，并由Leader进行代码合并。在merge代码时需要带上--no-off参数，以保留被合并的分支信息
- 需要评估hotfix分支在其他的版本上是否有同样问题的存在并存根，如果需要修复是采用合并分支还是新拉hotfix分支，根据实际情况确定

---

<a name="N14OM"></a>
# 分支管理
两个单一分支的命名如下：

- Master主干分支，直接使用主干master
- Develop开发分支，名称固定为：dev
  <a name="7IvTF"></a>
## Feature分支

- 命名格式：feature-{version}-{desc}
  - desc，简单功能说明
  - version，代表当前功能计划所在应用版本的版本号
- 分支描述，需要填写以下信息：
  - 第一行填写，关联的禅道taskId，如果有多个使用英文逗号隔开
  - 第二行开始，填写简单的功能描述信息
    <a name="xl68h"></a>
## Release分支

- 命名格式：release-{version}
  - version，代表当前需要发版的应用版本号
- 分支描述：按实际情况填写信息即可
  <a name="a3ka1"></a>
## Hotfix分支

- 命名格式：hotfix-{version}-{desc}
  - desc，简单bug描述
  - version，代表是哪个应用版本的bug
- 分支描述，需要填写以下信息：
  - 第一行填写禅道上的bugId，如果有多个使用英文逗号隔开。
  - 第二行开始，填写简单的问题描述信息
    <a name="qXhFi"></a>
## 提测发布Tag
这里的tag是指从release分支打出的提测用标签。

- 命名规则：{version}-{test.no}
  - 前段部分 {version} 就是当前发布分支的分支版本号
  - 后段部分中的{test.no}，是禅道上的提测版本号，CI会根据这个段来最新的提测代码
- 分支描述：按实际情况填写信息即可
  <a name="2HSiT"></a>
## 正式发版Tag
这里的tag是指应用正式发布版本所用的标签。

- 命名规则：使用当前应用发布的版本号，如4.8.2
- 分支描述，需要填写以下信息：
  - 第一行填写禅道上的planId，
  - 第二行开始，添加简单的发版说明

---

<a name="z44LH"></a>
# 其他操作
<a name="OFk19"></a>
## 代码提交
<a name="lyLpW"></a>
### 提交策略

- 一次提交尽量只涉及一个任务或者一个bug
- 修改禅道上已提交的bug时，不要和功能一起提交
  <a name="esF4w"></a>
### 消息格式

- 第一行填写禅道上的taskId或者bugId，如果有多个以英文逗号隔开
- 第二行开始，添加简单的说明，只是要说明这次提交的是新功能还是问他的修改
